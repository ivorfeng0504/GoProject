define(["jquery","cors","layer","handlebars","utils","nicescroll"],function(jquery,cors,layer,Handlebars,utils,nicescroll){layer.config({path:window.gConfig.staticPath+"static/libs/layer/"}),$.support.cors=!0;var page={nonedataHtml:'<div class="no-info">暂无数据显示，请稍后重试</div>',init:function(){utils.appendSSO();var a=this;$.support.cors=!0,a.index=0,a.flag=!0,a.firstArticle=!0,a.getUID=utils.getUID(),a.getAppId=appIDcloudinfo,a.hotNesData={},a.TopicId=utils.GetQueryString("TopId"),a.NewsInfoId=utils.GetQueryString("NewsID"),a.source=4,a.errorCount={},a.scrollContent(),a.relationNews(0),utils.thumbUP(".like,.encourage-icon",a.getUID,a.getAppId,"#zhutiScroll"),a.share(),window.pulldownLoad=function(){var e,t=null,i=!0;$(function(){(t=$("#zhutiScroll").getNiceScroll(0)).jqbind("#zhutiScroll","scroll",function(){t.newscrolly>=t.page.maxh-500&&i&&(i=!i,clearTimeout(e),e=setTimeout(function(){a.index>a.newDataArrayLength-1&&a.flag?(layer.tips("已加载全部","#zhutiScroll",{offset:["400px","50px"],tips:[2,"#cb4b4b"]}),a.flag=!1):a.flag&&a.updateInfo(a.newDataArray[a.index].DataUrl,"scroll"),i=!i},500))}),t.scrollend(function(){var s,e=$("#zhutiScroll .atticle-show");$.each(e,function(e,t){var i=$(t),a=i.offset().top,n=i.height();(a<=100&&n*(2/3)<a+n-60||100<a&&n*(2/3)<553-a+86)&&(s=i.attr("data-artid"))}),s!=undefined&&page.getNewsIDreadingCount(s)})})},window.pulldownLoad(),$("#goBack").on("click",function(){1<history.length?window.history.back():(window.location.href=pagerouter.zhuti,window.event.returnValue=!1)})},scrollContent:function(){$.each(["#zhutiScroll"],function(e,t){0<$(t).length&&$(t).niceScroll({cursorcolor:"#666",cursoropacitymax:.5,touchbehavior:!1,cursorwidth:"6px",cursorborder:"0",cursorborderradius:"8px",autohidemode:!1})})},getNewDataArray:function(e,t){var i=this,a=e.Message;i.newDataArrayLength=a.length,i.newDataArray=[];for(var n=0;n<i.newDataArrayLength;n++)if(a[n].NewsInformationId==t){var s=a.slice(0,n),r=a.slice(n+1,i.newDataArrayLength);i.newDataArray.push(a[n]),i.newDataArray=i.newDataArray.concat(r).concat(s)}},updateInfo:function(a,n){var s=this,r=$("#zhutiScroll"),i=["<div class='atticle-show section yaowen-article' id=\"atticleShow{{newsId}}\" data-artid={{newsId}}>","        <div class='a-iner'>","            <div class='art-title'>",'                <h3 id="artcleTitle" title="">{{article_title}}</h3>',"            </div>",'            <div class="art-subtitle">',"                <div class=' pull-right'>","                    <span class='view-tips'>",'                          <span class="vt-cell like" id="like{{newsId}}" data-channelid={{newsId}}>',"                               <i class='icon-1' id=\"likeicon{{newsId}}\">&#xe61b;</i>",'                                <span class="liked" id="liked{{newsId}}"></span>',"                          </span>",'                          <span class="vt-cell">',"                               <i class='icon-1'>&#xe602;</i>",'                               <span id="reading{{newsId}}"></span>',"                          </span>",'                           <span class="vt-cell">','                               <div class="fl ml10 bdsharebuttonbox" data-tag="share_{{newsId}}" style=" display: inline-block; vertical-align: middle;  margin-top: -5px;">','                                   <a href="javascript:;" class="bds_weixin" data-cmd="weixin" title="分享到微信" data-id="{{newsId}}" data-title="{{article_title}}"></a>','                                   <a href="javascript:" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博" data-id="{{newsId}}" data-title="{{article_title}}"></a>',"                               </div>","                         </span>","                    </span>","                </div>",'                <div class="ac-submain">',"                    <span>来源：{{article_source}}</span>","                    <span>{{renderTime publish_time}}</span>","                </div>","            </div>",'            <div class="art-cnt">','                <div class="ac-iner">','                    <div class="ac-content ywac-content" id="acScrollbox" data-fontsizecnt>',"                        {{htmled content}}","                    </div>","                </div>","            </div>","        </div>","    </div>"].join(""),o=function(){s.index<4&&s.updateInfo(s.newDataArray[s.index].DataUrl,n)},l=s.newDataArray[s.index].NewsInformationId;if(Handlebars.registerHelper("htmled",function(e){return e!=undefined&&null!=e&&0!=e.length||(e=""),new Handlebars.SafeString(e)}),Handlebars.registerHelper("renderTime",function(e){return e=e==undefined||null==e||0==e.length?"":"　"+e.slice(5,10)+" "+e.slice(11,16),new Handlebars.SafeString(e)}),window.XDomainRequest){var d=new XDomainRequest;d.open("get",a),d.onprogress=function(){},d.ontimeout=function(){},d.onerror=function(){"scroll"!=n&&!r.find(".yaowen-article").length&&r.append('<div class="atticle-show section yaowen-article no-info-cnt" id="atticleShow'+l+'" data-artid="'+l+'"><div class="no-info">资讯暂无数据显示，请稍后重试</div></div> ')},d.onload=function(){var e=JSON.parse(d.responseText);if(e.id!=undefined&&null!=e.id){e.newsId=l;var t=Handlebars.compile(i)(e);$("#zhutiScroll").find(".no-info").remove(),$("#zhutiScroll").append(t),s.getReadCount(l),s.getClickLike(l),s.index=s.index+1,o(),s.share(),window._bd_share_main&&window._bd_share_main.init&&window._bd_share_main.init()}else"scroll"!=n&&!r.find(".yaowen-article").length&&r.append('<div class="atticle-show section yaowen-article no-info-cnt" id="atticleShow'+l+'" data-artid="'+l+'"><div class="no-info">资讯暂无数据显示，请稍后重试</div></div> '),s.index=s.index+1,o()},setTimeout(function(){d.send()},0)}else $.ajax({url:a,type:"GET",timeout:ajaxTimeout,dataType:"json",success:function(e){if(e.id!=undefined&&null!=e.id){e.newsId=l;var t=Handlebars.compile(i)(e);$("#zhutiScroll").find(".no-info").remove(),$("#zhutiScroll").append(t),s.getReadCount(l),s.getClickLike(l),s.share(),window._bd_share_main&&window._bd_share_main.init&&window._bd_share_main.init()}else"scroll"!=n&&!r.find(".yaowen-article").length&&r.append('<div class="atticle-show section yaowen-article no-info-cnt" id="atticleShow'+l+'" data-artid="'+l+'"><div class="no-info">资讯暂无数据显示，请稍后重试</div></div> ');s.index=s.index+1,o()},error:function(e,t,i){s.errorCount[l]||(s.errorCount[l]=0),s.errorCount[l]++,s.errorCount[l]<=1&&"scroll"!=n?s.updateInfo(a+"?1",n):("scroll"!=n&&!r.find(".yaowen-article").length&&r.append('<div class="atticle-show section yaowen-article no-info-cnt" id="atticleShow'+l+'" data-artid="'+l+'"><div class="no-info">资讯暂无数据显示，请稍后重试</div></div> '),s.index=s.index+1,o())}})},relationNews:function(a){var n=this,s=$("#hotNewsList"),t=["{{#each Message}}",'<li cid="{{NewsInformationId}}" clickkey="articleAside|list" clickdata="{{NewsInformationId}}|zhuti_article" clickremark="" >','<a href="javascript:;">','<i class="icon-1">&#xe637;</i>',"<span>{{ArticleTitle}}</span>","</a>","</li>","{{/each}}"].join("");$.ajax({url:window.gConfig.apiHost+"expertnews/gettopicnews",type:"GET",timeout:ajaxTimeout,dataType:"JSON",data:{TopicId:n.TopicId},success:function(i){if(0==i.RetCode&&i.Message&&0<i.Message.length){var e=Handlebars.compile(t)(i);s.empty().append(e),$("li",s).on("click",function(){var e=$(this);n.index=0,$("#zhutiScroll").empty();var t=e.attr("cid");n.getNewDataArray(i,t),n.firstArticle=!0,n.newDataArray&&n.newDataArray[a]&&n.updateInfo(n.newDataArray[a].DataUrl)}),$('[cid="'+n.NewsInfoId+'"]',s).eq(0).trigger("click")}else s.html(page.nonedataHtml)},error:function(e,t,i){s.html(page.nonedataHtml)}})},getReadCount:function(a){var t=this;$.ajax({url:window.gConfig.apiHost+"click/queryclick",type:"GET",timeout:ajaxTimeout,dataType:"JSON",cache:!1,data:{identity:a,clickType:"news.information"},success:function(e){$("#reading"+a).text(e.Message.Result[a]),1==t.firstArticle&&(t.getNewsIDreadingCount(a),t.firstArticle=!1)},error:function(e,t,i){$("#reading"+a).text(parseInt(300*Math.random()))}})},getNewsIDreadingCount:function(e){if(e!=undefined&&""!=e&&null!=e&&0!=e){var i=$("#reading"+e);i.attr("viewed")||(i.text(parseInt(i.text())+1),i.attr("viewed","1"),$.ajax({type:"get",timeout:ajaxTimeout,url:window.gConfig.apiHost+"click/addclick",contentType:"text/plain",cache:!1,data:{identity:e,clickType:"news.information"},dataType:"json",success:function(e,t){"success"===t&&0==e.RetCode&&"SUCCESS"==e.RetMsg&&i.text(e.Message)},error:function(e,t,i){}}))}},getClickLike:function(i){var a=$("#like"+i),n=$("#likeicon"+i);$.ajax({type:"get",timeout:ajaxTimeout,contentType:"text/plain",dataType:"json",url:window.gConfig.likeDataServer,data:{uid:this.getUID,newsId:i,appId:this.getAppId},success:function(e,t){e.isSucess?a.attr("data-channelid")==i&&($("#liked"+i).text(e.message.likes),!0===e.message.liked?(n.html("&#xe66b;"),a.addClass("liked")):a.removeClass("liked")):a.removeClass("liked")},error:function(e,t,i){a.removeClass("liked")}})},share:function(){var _this=this,shareId="",title="";function SetConf(e,t){return shareId&&(t.bdUrl=url,t.bdText=title),t}with($(function(){$(".bdsharebuttonbox a").mouseover(function(){shareId=$(this).attr("data-id"),title=$(this).attr("data-title"),url=pagerouter.share+"?type=1&NewsID="+shareId+"&source="+_this.source})}),window._bd_share_config={common:{onBeforeClick:SetConf},share:[{bdSize:12}],image:[{viewType:"list",viewPos:"top",viewColor:"black",viewSize:"12",viewList:["weixin","tsina"]}],selectShare:[{bdselectMiniList:["weixin","tsina"]}]},document)(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion="+~(-new Date/36e5)}};page.init(),$.emoneyAanalytics().Init(tjAppid.expert,"zhuti_article","")});