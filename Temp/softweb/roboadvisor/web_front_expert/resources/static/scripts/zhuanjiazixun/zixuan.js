define(["jquery","cors","layer","utils","handlebars","autocomplete","nicescroll"],function(e,t,r,a,n,s,i){r.config({path:window.gConfig.staticPath+"static/libs/layer/"}),$.support.cors=!0,{EMSSOSTR:"",init:function(){var e=this;$.cookie("expertnews.uid")?e.getUID=$.cookie("expertnews.uid"):(e.getUID=a.GetQueryString("uid")||1,$.cookie("expertnews.uid",e.getUID)),e.EMSSOSTR=a.EMSSO(),e.getUID=$.cookie("expertnews.uid")||a.GetQueryString("uid")||1,e.getAppId=1015004,e.handerbarsFormat(),e.scrollContent(),e.autoComplete(),e.release(),e.getWeiGuList(),e.celuevideoinfo(),e.autoInterval(),e.EM_HREF_JUMP()},handerbarsFormat:function(){n.registerHelper("renderTime",function(e){var t=new Date,a=t.getMonth()+1,s=a<=9?"0"+a:a,i=t.getFullYear()+"-"+s+"-"+t.getDate();return e=e==undefined||null==e||0==e.length?"":e.slice(0,10)==i?e.slice(11,16):e.slice(5,10)+" "+e.slice(11,16),new n.SafeString(e)})},autoInterval:function(){var e=this;setInterval(function(){e.getWeiGuList(),e.celuevideoinfo()},6e4)},scrollContent:function(){var e=this;e.srcollBar=function(){$(".list").css("height",$(window).height()-35),$.each([".list"],function(e,t){0<$(t).length&&$(t).niceScroll({cursorcolor:"#666",cursoropacitymax:.5,touchbehavior:!1,cursorwidth:"6px",cursorborder:"0",cursorborderradius:"8px",autohidemode:!1})})},e.srcollBar(),$(window).on("resize",function(){e.srcollBar()})},autoComplete:function(){var a=[];$(EALists).each(function(e,t){"A股"==t._T&&a.push(t)}),$("#txt_add_stockname").autocomplete(a,{minChars:0,max:10,autoFill:!1,mustMatch:!1,matchContains:!0,scrollHeight:200,formatItem:function(e){return e._C+" "+e._N},formatMatch:function(e){return e._C+" "+e._S+" "+e._N},formatResult:function(e){return e._N}})},release:function(){var n=this;n.$sayBtn=$("#sayBtn"),n.sayBox=$("#sayBox");var e=$("#release"),t=$("#close");n.$stock=$("#txt_add_stockname"),n.$content=$("#content"),n.$sayBtn.on("click",function(){$(this);n.$stock.val(""),n.$content.val(""),n.sayBox.addClass("open")}),e.on("click",function(){$(this);var a,s=n.$stock.val(),e=n.$content.val(),i=!1,t=!0;if(s)if($(EALists).each(function(e,t){t._N==s&&(a=t._C,i=!0)}),i){if(!e)setTimeout(function(){r.msg("请输入对股票的看法",{offset:["50%","20%"]})},200)}else setTimeout(function(){r.msg("请输入正确股票代码",{offset:["50%","20%"]})},200);else setTimeout(function(){r.msg("请输入股票代码",{offset:["50%","20%"]})},200);if(!s&&!e)setTimeout(function(){r.msg("请输入股票代码与看法",{offset:["50%","20%"]}),n.$stock.val()},200);a&&s&&e&&t&&$.ajax({url:window.gConfig.myoptApiHost+"stocktalk/addstocktalk",type:"POST",timeout:ajaxTimeout,dataType:"JSON",data:{StockCode:a,StockName:s,Content:e},success:function(e){if(0==e.RetCode){t=!1,n.sayBox.removeClass("open"),n.$sayBtn.removeClass("close");setTimeout(function(){r.msg("消息已发送",{offset:["50%","20%"]})},200)}else r.msg(e.RetMsg,{offset:["50%","20%"]})},error:function(e,t,a){}})}),t.on("click",function(){$(this);n.sayBox.removeClass("open")})},getWeiGuList:function(){n.registerHelper("subStr",function(e,t){return e==undefined||null==e||0==e.length?time="":e.length>t&&(e=$.trim(e).substr(0,t)+"..."),new n.SafeString(e)});var s=["{{#each Message}}",'<li class="weigu-item" data-id="{{StockTalkId}}">','   <div class="desc">',"       {{#if Avatar}}",'       <img class="photo" src="{{Avatar}}" /> {{else}}','       <img class="photo" src="'+defaultAvatar+'" /> {{/if}}','       <span class="name">{{NickName}}</span>','        <span class="time">{{renderTime CreateTime}}</span>',"   </div>",'   <div class="content-box">','<i class="pointer-angle"><em></em></i>','        <div class="intro">','              <span class="name"><span class="stockname" data-stockCode="{{StockCode}}">{{StockName}}</span><i class="ask-answer icon-1">&#xe62c;</i></span>','               <span class="like-box"><i class="icon-1">&#xe61b;</i><span class="like" id="like{{StockTalkId}}">888</span></span>','               <div class="clearfloat"></div>',"         </div>",'         <div class="content">{{subStr Content 200}}</div>',"   </div>","</li>","{{/each}}"].join(""),i=this;$.ajax({url:window.gConfig.myoptApiHost+"stocktalk/getstocktalk",type:"POST",timeout:ajaxTimeout,dataType:"JSON",data:{Date:"",Incre:!1},success:function(e){if(0==e.RetCode){var t=$("#weiguList"),a=n.compile(s)(e);t.html(a),i.clickLike(),i.$content=$("#content"),$(".ask-answer",t).on("click",function(){var e=$(this),t=e.siblings(".stockname").text();e.siblings(".stockname").attr("data-stockCode");i.$stock.val(t),i.$content.val(""),i.autoComplete(),i.sayBox.addClass("open")})}},error:function(e,t,a){}})},clickLike:function(){var t=this,a=[],i=$("#weiguList");$(".like",i).each(function(){var e=$(this).parents("li").attr("data-id");a.push({uid:t.getUID,newsId:e,appId:t.getAppId})}),$.ajax({type:"get",timeout:ajaxTimeout,contentType:"text/plain",dataType:"jsonp",url:window.gConfig.likeListDataServerJsonp,data:{jsondata:JSON.stringify(a)},success:function(s,e){s.isSucess?$(".like",i).each(function(){for(var e=$(this),t=e.parents("li").attr("data-id"),a=0;a<s.message.length;a++)s.message[a].newsId==t&&(1==s.message[a].liked&&(e.siblings("i").html("&#xe66b;"),e.siblings("i").addClass("liked")),e.text(s.message[a].likes))}):$(".like",i).each(function(){$(this).text(0)})},error:function(e,t,a){$(".like",i).each(function(){$(this).text(0)})}}),$(".like-box .icon-1").off().on("click",function(){var i=$(this),n=i.parents("li").attr("data-id");i.hasClass("liked")||$.ajax({type:"get",timeout:ajaxTimeout,dataType:"jsonp",url:window.gConfig.likeDataServerJsonp,data:{uid:t.getUID,newsId:n,appId:t.getAppId},success:function(e,t){if("success"===t){if(e.isSucess){var a=$("#like"+n).text();i.addClass("liked"),$("#like"+n).text(Number(a)+1),i.html("&#xe66b;")}}else{a=$("#like"+n).text();i.addClass("liked"),$("#like"+n).text(Number(a)+1),i.html("&#xe66b;")}},error:function(e,t,a){var s=$("#like"+n).text();i.addClass("liked"),$("#like"+n).text(Number(s)+1),i.html("&#xe66b;")}})})},celuevideoinfo:function(){var s,e=$.cookie("expertnews.uid"),t=["{{#each Message}}",'<li class="strategy-item">',"{{#isValid LatestLive}}",'<div class="si-p">','<a class="photo-link" href="'+pagerouter.yqqUserLive+'?lid={{ LatestLive.LId }}"  target="_blank"> {{#if ExpertNewsStrategy.StrategyImg}}','<img class="photo" src="{{ExpertNewsStrategy.StrategyImg}}" /> {{else}}','<img class="photo" src="'+defaultAvatar+'" /> {{/if}}</a>','<div class="brief-intro">','<a class="name" href="javascript:;" data-ahref="'+pagerouter.zhuanjiacelueList+'?StrategyID={{ExpertNewsStrategy.ID}}&LiveID={{ExpertNewsStrategy.LiveID}}&ColumnID=16&currpage=1&pageSize=3">{{ ExpertNewsStrategy.StrategyName }}</a>','<span class="time"><span>{{renderTime LatestLive.SendTime}}</span> <span class="live">正在直播</span></span>',"</div>",'<a class="kankan" href="'+pagerouter.yqqUserLive+'?lid={{ LatestLive.LId }}" target="_blank">看直播</a>','<div class="clearfloat"></div>',"</div>",'<div class="content">','    <a href="'+pagerouter.yqqUserLive+'?lid={{ LatestLive.LId }}" target="_blank">',"        {{removeHTMLtags LatestLive.LiveContent}}","     </a>"," </div>","{{/isValid}}","{{#isValid LatestNews}}",'<div class="si-p">','<a class="photo-link" href="javascript:;" data-ahref="'+pagerouter.zhuanjiacelueList+'?StrategyID={{ExpertNewsStrategy.ID}}&LiveID={{ExpertNewsStrategy.LiveID}}&ColumnID=16&currpage=1&pageSize=3"> {{#if ExpertNewsStrategy.StrategyImg}}','<img class="photo" src="{{ExpertNewsStrategy.StrategyImg}}" /> {{else}}','<img class="photo" src="'+defaultAvatar+'" /> {{/if}}</a>','<div class="brief-intro">','<a class="name" href="javascript:;" data-ahref="'+pagerouter.zhuanjiacelueList+'?StrategyID={{ExpertNewsStrategy.ID}}&LiveID={{ExpertNewsStrategy.LiveID}}&ColumnID=16&currpage=1&pageSize=3">{{ ExpertNewsStrategy.StrategyName }}</a>','<span class="time"><span>{{renderTime LatestNews.CreateTime }}</span> <span class="live"> 发表了新观点 </span></span>',"</div>",'<a class="kankan" href="javascript:;" data-ahref="'+pagerouter.celueArticle+'?StrategyID={{ExpertNewsStrategy.ID}}&LiveID={{ExpertNewsStrategy.LiveID}}&NewsID={{LatestNews.ID}}&ColumnID=16&source=ll&currpage=1&pageSize=3">读文章</a>','<div class="clearfloat"></div>',"</div>",'<div class="content">','   <a href="javascript:;" data-ahref="'+pagerouter.celueArticle+'?StrategyID={{ExpertNewsStrategy.ID}}&LiveID={{ExpertNewsStrategy.LiveID}}&NewsID={{LatestNews.ID}}&ColumnID=16&source=ll&currpage=1&pageSize=3">',"         {{LatestNews.Title}}","   </a>"," </div>","{{/isValid}}","</li>","{{/each}}"].join("");n.registerHelper("isValid",function(e,t){return null==e?t.inverse(this):t.fn(this)}),n.registerHelper("removeHTMLtags",function(e){var t;return e==undefined||null==e?timestr="":t=$("<div>"+e+"</div>").text(),new n.SafeString(t)}),n.registerHelper("renderDateTime",function(e){var t;return t=e==undefined||null==e||0==e.length?"":(e=e.replace("T"," ")).substr(11,5),new n.SafeString(t)}),n.registerHelper("BigCastorSummary",function(e){var t,a=$("<div>"+e+"</div>").text();return t=a.length>(a=a.slice(0,50)).length?"…":"",new n.SafeString(a+t)});s=n.compile(t),$.ajax({type:"get",timeout:ajaxTimeout,url:window.gConfig.myoptApiHost+"strategy/getfocusstrategylist",contentType:"application/json",type:"GET",timeout:ajaxTimeout,dataType:"JSON",data:{UID:e},success:function(e,t){if("success"===t&&0==e.RetCode&&"SUCCESS"==e.RetMsg){var a=s(e);$("#followedStrategyList").html(a)}}})},EM_HREF_JUMP:function(){function s(e,t){try{return function a(){return window.external.EmObj}().EmFunc(e,t)}catch(s){}}$("#followedStrategyList").on("click","a[data-ahref]",function(){var e=$(this).attr("data-ahref"),t=window.gConfig.expertBaseUrl+e+"&";try{s("EM_FUNC_ZNTG_CLZL",t)}catch(a){}})}}.init()});