define(["jquery","cors","utils","layer","handlebars","nicescroll"],function($,cors,utils,layer,Handlebars,nicescroll){layer.config({path:window.gConfig.staticPath+"static/libs/layer/"}),$.support.cors=!0;var page={currStrategyinfo:{},curPageOpts:{NewsID:0,ColumnID:confColumnID,StrategyID:0,currpage:1,pageSize:5,LiveID:0,ExpertLiveroom:pagerouter.yqqUserLive+"?lid=93&"+utils.EMSSO(),isbg:!1,zanparams:[]},init:function(){var e=this;e.getUID=utils.getUID(),$.support.cors=!0,e.firstArticle=!0,e.curPageOpts.NewsID=utils.GetQueryString("NewsID"),e.curPageOpts.LiveID=utils.GetQueryString("LiveID"),e.curPageOpts.StrategyID=utils.GetQueryString("StrategyID"),e.curPageOpts.currpage=utils.GetQueryString("currpage"),e.curPageOpts.pageSize=utils.GetQueryString("pageSize"),e.curPageOpts.ExpertLiveroom=pagerouter.yqqUserLive+"?lid="+utils.GetQueryString("LiveID")+"&"+utils.EMSSO(),utils.appendSSO(),$("#gotoExpliveroom").attr("href",e.curPageOpts.ExpertLiveroom),e.setScroll(),e.newsInfoListshow(),e.syncScrollState(),e.readingAllArticle(),window.livethumbUP(".clickbtn-like",e.getUID,appIDLiveInfo,"#StrategyInfoList"),$("#goBack").on("click",function(){1<history.length?window.history.back():(window.location.href=pagerouter.celueHome,window.event.returnValue=!1)})},syncScrollState:function(){var i=this;window.pulldownLoad=function(){var e,t=null,a=!0;$(function(){(t=$("#acScrollbox").getNiceScroll(0)).jqbind("#acScrollbox","scroll",function(){i.curPageOpts.isbg||t.newscrolly==t.page.maxh&&a&&(a=!a,clearTimeout(e),i.curPageOpts.currpage=parseInt(i.curPageOpts.currpage)+1,e=setTimeout(function(){i.newsInfoListshow(),a=!a},500))}),t.scrollend(function(){var r,n,o,e=$("#acScrollbox .celue-article");$.each(e,function(e,t){var a=$(t),i=a.offset().top,s=a.height();(i<=100&&s*(2/3)<i+s-60||100<i&&s*(2/3)<553-i+86)&&(r=a.attr("data-artid"),n=a.attr("data-artcelueid"),o=a.attr("data-artliveid"))}),o!=undefined&&i.curPageOpts.LiveID!=o&&(i.curPageOpts.LiveID=o,$("#zbzx").empty().attr("data-filled",""),$("#gotoExpliveroom").attr("href",pagerouter.yqqUserLive+"?lid="+i.curPageOpts.LiveID+"&"+utils.EMSSO())),r!=undefined&&page.getNewsIDreadingCount(r),page.currStrategyinfo[n]!=undefined&&page.currentBigCastor(page.currStrategyinfo[n])})})},window.pulldownLoad()},isInVisible:function(e){var t=$("[data-artid='"+e+"']");return 0!=t.length&&(t.offset().top<250&&70<t.offset().top)},isCurArticle:function(){var a,i,s,r=this,e=$("#StrategyInfoList [data-artid]");$.each(e,function(e,t){if(a=$(t).attr("data-artid"),i=$(t).attr("data-artliveid"),s=$(t).attr("data-artcelueid"),r.isInVisible(a)){if(r.StrategyID==a)return;return r.StrategyID,r.currentBigCastor(r.currStrategyinfo[a]),{artid:a,artliveid:i,artcelueid:s}}return!1})},setScroll:function(){$.each(["#medialistScroll","#medialistScroll2","#iveNlPack","#iveNlPack2","#yaowenNlPack","#iveYwNlPack"],function(e,t){0<$(t).length&&$(t).niceScroll({cursorcolor:"#666",cursoropacitymax:.5,touchbehavior:!1,cursorwidth:"6px",cursorborder:"0",cursorborderradius:"8px",autohidemode:!1})}),$("#acScrollbox").niceScroll({cursorcolor:"#666",cursoropacitymax:.5,touchbehavior:!1,cursorwidth:"6px",cursorborder:"0",cursorborderradius:"8px",autohidemode:!1})},newsInfoListshow:function(){var r=this;r.StrategyID=utils.GetQueryString("StrategyID");var n={ColumnID:confColumnID,StrategyID:r.StrategyID,currpage:r.curPageOpts.currpage,pageSize:r.curPageOpts.pageSize},e="ll"==utils.GetQueryString("source")?window.gConfig.apiHost+"strategy/GetStrategyNewsList":window.gConfig.apiHost+"strategy/GetStrategyNewsList_Rmgd",t=(utils.objToQuery(n),["<div data-page={{ currpage }}>","{{#each Message}}",'    <div class="atticle-show section celue-article" id="Article_{{ NewsInfo.ID }}" data-artcelueid={{StrategyInfo.ID}} data-artliveid={{StrategyInfo.LiveID}} data-artid="{{colectnewsid StrategyInfo.LiveID NewsInfo.ID}}">','        <div class="a-iner">','            <div class="art-title">','                <h3 id="artcleTitle{{NewsInfo.ID}}">{{ NewsInfo.Title }}</h3>',"            </div>",'            <div class="art-subtitle">','                <div class=" pull-right">','                    <span class="view-tips">','                        <span class="vt-cell clickbtn-like " id="clickLikeBtn{{StrategyInfo.LiveID}}_{{NewsInfo.ID}}" data-channelid="{{StrategyInfo.LiveID}}_{{NewsInfo.ID}}">','                            <i class="icon-1" id="likeicon{{StrategyInfo.LiveID}}_{{NewsInfo.ID}}">&#xe66b;</i>','                            <span class="clickLikes" id="liked{{StrategyInfo.LiveID}}_{{NewsInfo.ID}}"> </span>',"                        </span>",'                        <span class="vt-cell" id="clickViewPack{{NewsInfo.ID}}" >','                            <i class="icon-1">&#xe602;</i>','                            <span class="clickNum" id="clickViewNum{{NewsInfo.ID}}"></span>',"                        </span>",'                        <span class="vt-cell">','                            <div class="bdsharebuttonbox" style=" display: inline-block; vertical-align: middle;  margin-top: -5px;">','                                <a href="javascript:;" class="bds_weixin" data-cmd="weixin" data-id="{{NewsInfo.ID}}" data-strategyid={{StrategyInfo.ID}}  data-title="{{ NewsInfo.Title }}" title="分享到微信"></a>','                                <a href="javascript:;" class="bds_tsina" data-cmd="tsina" data-id="{{NewsInfo.ID}}" data-strategyid={{StrategyInfo.ID}}  data-title="{{ NewsInfo.Title }}" title="分享到新浪微博"></a>',"                            </div>","                        </span>","                    </span>","                </div>",'                <div class="pull-left fnt-ctrl" id="fntCtrl">',"                </div>",'                <div class="ac-submain">',"                    <span >来源：{{ StrategyInfo.StrategyName }} </span>","                    <span > {{renderDateTime NewsInfo.CreateTime}} </span>","                </div>","            </div>",'            <div class="art-cnt">','                <div class="ac-iner">','                    <div class="ac-content" data-fontsizecnt>',"                       {{contentInfo NewsInfo.NewsContent }} ","                    </div>","                </div>","            </div>","        </div>","    </div>","{{/each}}","</div>"].join(""));Handlebars.registerHelper("colectnewsid",function(e,t){return r.curPageOpts.zanparams.push({newsId:e+"_"+t,uid:utils.getUID(),appId:appIDLiveInfo}),t}),Handlebars.registerHelper("renderDateTime",function(e){var t;return t=e==undefined||null==e||0==e.length?"":(e=e.replace("T"," ")).substr(5,11),new Handlebars.SafeString(t)}),Handlebars.registerHelper("contentSummary",function(e){var t,a=$("<div>"+e+"</div>").text();return t=a.length>(a=a.slice(0,100)).length?"…":"",new Handlebars.SafeString(a+t)}),Handlebars.registerHelper("contentInfo",function(e){return e=utils.replaceTarget(e),new Handlebars.SafeString(e)});var o=Handlebars.compile(t);$.ajax({url:e,type:"GET",timeout:ajaxTimeout,dataType:"json",data:n,success:function(e,t){if(layer.close(r.tip),0==e.RetCode&&e.Message&&0<e.Message.length){$.extend(e,{currpage:n.currpage});var a=o(e);"filled"!=$("#StrategyInfoList").attr("data-filled")?($("#StrategyInfoList").attr("data-filled","filled"),$("#StrategyInfoList").removeClass("no-info-cnt").html(a)):($("#StrategyInfoList").find(".no-info").remove(),$("#StrategyInfoList").removeClass("no-info-cnt").append(a)),r.share1(),window._bd_share_main&&window._bd_share_main.init&&window._bd_share_main.init(),$("#StrategyInfoList [data-page='"+r.curPageOpts.currpage+"'] .clickNum").each(function(){var e=$(this).parents(".atticle-show").attr("data-artid");r.getReadCount(e)});utils.getUID(),appIDnewsinfo;var i=$("#acScrollbox").getNiceScroll(0),s=$("#acScrollbox .ac-content img").length;"complete"==this.readyState||this.readyState,utils.GetQueryString("NewsID")&&$("#acScrollbox .ac-content img").load(function(){--s||("ll"==utils.GetQueryString("source")?i.doScrollTop($("[data-artid='"+utils.GetQueryString("NewsID")+"']").offset().top-71-15):1==r.curPageOpts.currpage&&i.doScrollTop($("[data-artid='"+utils.GetQueryString("NewsID")+"']").offset().top-71-15))}).error(function(){--s||("ll"==utils.GetQueryString("source")?i.doScrollTop($("[data-artid='"+utils.GetQueryString("NewsID")+"']").offset().top-71-15):1==r.curPageOpts.currpage&&i.doScrollTop($("[data-artid='"+utils.GetQueryString("NewsID")+"']").offset().top-71-15))})}else 0==e.RetCode&&null==e.Message&&(r.curPageOpts.isbg=!0,layer.tips("已加载全部","#acScrollbox",{offset:["400px","50px"],tips:[2,"#cb4b4b"]}))},error:function(e,t,a){}}).then(function(e){0==e.RetCode&&e.Message&&0<e.Message.length&&(r.getLikesCollect(r.curPageOpts.zanparams),$.each(e.Message,function(e,t){r.currStrategyinfo[t.StrategyInfo.ID]=JSON.parse(JSON.stringify(t.StrategyInfo))}),1==r.curPageOpts.currpage&&r.currentBigCastor(r.currStrategyinfo[r.StrategyID]))})},readingAllArticle:function(){$("#StrategyInfoList").on("click",".reading-more",function(){var e=$(this);e.siblings(".ac-content").addClass("heightAuto"),e.addClass("close")})},StrategyArticleShow:function(e){var t=this;""!=t.curPageOpts.NewsID&&$.ajax({url:window.gConfig.apiHost+"strategy/GetNextStrategyNewsListByCurrNews",timeout:ajaxTimeout,data:{v:""+Math.random(),NewsID:e,ColumnID:confColumnID,StrategyID:utils.GetQueryString("StrategyID"),currpage:t.curPageOpts.currpage,pageSize:t.curPageOpts.pageSize},success:function(e){if(0==e.RetCode){null==e.Message[1].NewsInfo&&(layer.msg("此条资讯已移除，请浏览其他资讯"),setTimeout(function(){window.history.back()},2e3)),document.title=e.Message[1].NewsInfo.Title+" - 专家策略",$("#artcleTitle").text(e.Message[1].NewsInfo.Title),e.Message[1].StrategyInfo&&(t.curPageOpts.LiveID=e.Message[1].StrategyInfo.LiveID,$("#articleComefrom").text("来源："+e.Message[1].StrategyInfo.StrategyName)),$("#articlePublishtime").text("　"+e.Message[1].NewsInfo.CreateTime.slice(5,10)+" "+e.Message[1].NewsInfo.CreateTime.slice(11,16)),$("#clickNum").text(e.Message[1].NewsInfo.ClickNum),$("#acScrollbox").getNiceScroll(0).doScrollTop(0,.01),$("#acScrollbox").html(e.Message[1].NewsInfo.NewsContent),$("#gotoExpliveroom").attr("href",pagerouter.yqqUserLive+"?lid="+t.curPageOpts.LiveID+"&"+utils.EMSSO());var a,i=utils.getUID(),s=appIDnewsinfo,r=[];$.each($("#tacticsList [data-page="+page.curPageOpts.currpage+"] .section"),function(e,t){a=$(".clickbtn-like",t).data("channelid"),r.push({newsId:a,uid:i,appId:s})}),t.getLikesCollect(r),t.getClickLike()}}})},prenextArticle:function(e){utils.objToQuery(this.curPageOpts);if(0==e.RetCode&&0<e.Message.length){var t="";null!=e.Message[0].NewsInfo?t+='<div>上一条：<a class="linellips" data-NewsID='+e.Message[0].NewsInfo.ID+' href="javascript:;"> '+e.Message[0].NewsInfo.Title+" </a> </div>":t+="<div>　 </div>",null!=e.Message[2].NewsInfo?(utils.objToQuery(this.curPageOpts),t+='<div>下一条：<a class="linellips"  data-NewsID='+e.Message[2].NewsInfo.ID+' href="javascript:;"> '+e.Message[2].NewsInfo.Title+" </a> </div>"):t+="<div> 　 </div>",$("#prenextLine").html(t)}},histArticlesBind:function(e){var t=this;$("#hisArticleList,#prenextLine").on("click","a",function(){t.curPageOpts.NewsID=$(this).attr("data-newsid")})},hotArticlesList:function(e){var r=this;r.curPageOpts.currpage=utils.GetQueryString("currpage"),r.curPageOpts.pageSize=utils.GetQueryString("pageSize");var t=["<ul>","{{#each Message}}",'    <li><a href="javascript:;" data-NewsID="{{ NewsInfo.ID }}" ><i class="icon-1">&#xe637;</i>{{ NewsInfo.Title }}</a></li>',"{{/each}}","</ul>"].join("");Handlebars.registerHelper("renderTime",function(e){return e=e==undefined||null==e||0==e.length?"":e.substr(0,10),new Handlebars.SafeString(e)});var n=Handlebars.compile(t);$.ajax({type:"get",timeout:ajaxTimeout,url:window.gConfig.apiHost+"strategy/GetStrategyNewsList",data:{ColumnID:confColumnID,StrategyID:e,currpage:1,pageSize:10},success:function(e){var t={Message:[]};if(0==e.RetCode&&0<e.Message.length){for(var a=0,i=e.Message.length;a<i&&!(e.Message[a].NewsInfo.ID!=r.curPageOpts.NewsID&&(t.Message.push(e.Message[a]),3<=t.Message.length));a++);if(t.Message=t.Message.slice(0,3),0<t.Message.length){var s=n(t);$("#hisArticleList").html(s)}else $("#hisArticleList").html("<div>暂无其他文章</div>")}}})},currentBigCastor:function(e){var t=e,a="ll"==utils.GetQueryString("source")?"bigcast":"hotbigcast",i=pagerouter.zhuanjiacelueList+"?StrategyID="+e.ID+"&LiveID="+this.curPageOpts.LiveID,s=['<div class="item">','\t<div class="item-heading">','\t\t<a href="'+i+'"  clickkey="'+a+'|logo" clickdata="'+e.ID+'|zhuanjiacelue_list" clickremark="" ><div class="media">','\t\t\t<img src="{{StrategyImg}}" alt="">',"\t\t</div></a>","\t</div>",'\t<div class="item-content">',"\t\t<h4>",'\t\t<a href="'+i+'"  clickkey="'+a+'|title" clickdata="'+e.ID+'|zhuanjiacelue_list" clickremark="" >{{StrategyName}}</a>',"\t\t</h4>",'\t\t<div class="text"><a href="  '+i+'"  clickkey="'+a+'|summary" clickdata="'+e.ID+'|zhuanjiacelue_list" clickremark=""> {{BigCastorSummary StrategySummary}}</a> </div>',"\t</div>",'\t<div class="clearfloat"></div>',"</div>"].join("");Handlebars.registerHelper("isfirst",function(e){return v1==v2?options.fn(this):options.inverse(this)});var r=Handlebars.compile(s);Handlebars.registerHelper("BigCastorSummary",function(e){var t,a=$("<div>"+e+"</div>").text();return t=a.length>(a=a.slice(0,50)).length?"…":"",new Handlebars.SafeString(a+t)});var n=r(t);$("#bigCastSpeaker").html(n)},jinnangshow:function(e){utils.GetQueryString("LiveID");var t=pagerouter.yqqUserLive+"?lid="+this.curPageOpts.LiveID+" &"+utils.EMSSO(),a=['<div class="item">','\t<div class="item-content">',"\t\t<b>",'\t\t<a href="'+t+'" target="_blank"> {{BagName}}</a>',"\t\t</b>",'\t\t<div class="text"><a href="'+t+'" target="_blank"><div>{{contentSummary BagSummary}}</div></a></div>',"\t</div>","</div>"].join(""),i=Handlebars.compile(a);Handlebars.registerHelper("contentSummary",function(e){var t,a=$("<div>"+e+"</div>").text();return t=a.length>(a=a.slice(0,50)).length?"…":"",new Handlebars.SafeString(a+t)}),$.ajax({url:window.gConfig.apiHost+"yqq/getskilbag",data:{lid:e},timeout:ajaxTimeout,success:function(e){var t=JSON.parse(e);if(0==t.RetCode&&0<t.Data.length){var a=i(t.Data[0]);$("#jinnangPack").html(a)}else $("#jinnangPack").html(t.RetMsg)}})},getLikesCollect:function(e){var r={};$.ajax({type:"get",timeout:ajaxTimeout,contentType:"text/plain",dataType:"jsonp",url:window.gConfig.likeListDataServerJsonp,data:{jsondata:JSON.stringify(e)},success:function(a){var i,s;layer.close(void 0),a.isSucess&&($.each(a.message,function(e,t){r[a.message[e].newsId]={liked:a.message[e].liked,likes:a.message[e].likes}}),$.each(e,function(e,t){i=$("#clickLikeBtn"+t.newsId),s=t.newsId,r[s].liked?($(".icon-1",i).html("&#xe66b;"),i.addClass("liked")):($(".icon-1",i).html("&#xe61b;"),i.removeClass("liked")),$(".clickLikes",i).html(r[s].likes)}))}})},getClickLike:function(){var e=utils.getUID(),t=utils.GetQueryString("NewsID"),a=appIDLiveInfo,i=$(".clickbtn-like"),s=$(".icon-1",i),r=$(".clickLikes",i);this.requestLikeServer(e,t,a,i,s,r)},requestLikeServer:function(e,t,a,i,s,r){$.ajax({type:"get",timeout:ajaxTimeout,url:window.gConfig.likeDataServerJsonp,contentType:"text/plain",dataType:"jsonp",data:{uid:e,newsId:t,appId:a},success:function(e,t){"success"===t&&(e.isSucess?(r.text(e.message.likes),!0===e.message.liked?(i.addClass("liked"),s.html("&#xe66b;")):(i.removeClass("liked"),s.html("&#xe61b;"))):(i.removeClass("liked"),s.html("&#xe61b;")))},error:function(e,t,a){i.removeClass("liked"),s.html("&#xe61b;")}})},getReadCount:function(t){var a=this;$.ajax({url:window.gConfig.apiHost+"click/queryclick",type:"GET",timeout:ajaxTimeout,dataType:"JSON",cache:!1,data:{identity:t,clickType:"news.strategyNewsInfo"},success:function(e){$("#clickViewNum"+t).text(e.Message.Result[t]),1==a.firstArticle&&(a.getNewsIDreadingCount(a.curPageOpts.NewsID),a.firstArticle=!1)},error:function(e,t,a){}})},getNewsIDreadingCount:function(a){var e;a!=undefined&&""!=a&&null!=a&&0!=a&&((e=$("#clickViewNum"+a)).attr("viewed")||(e.text(parseInt(e.text())+1),e.attr("viewed","1"),$.ajax({type:"get",timeout:ajaxTimeout,url:window.gConfig.apiHost+"click/addclick",contentType:"text/plain",cache:!1,data:{identity:a,clickType:"news.strategyNewsInfo"},dataType:"json",success:function(e,t){"success"===t&&0==e.RetCode&&"SUCCESS"==e.RetMsg&&$("#clickViewNum"+a).text(e.Message)},error:function(e,t,a){}})))},isFollowed:function(){$.ajax({type:"get",timeout:ajaxTimeout,url:window.gConfig.apiHost+"strategy/HasFocusStrategy?UID=1&StrategyID=1",data:{uid:getUID,StrategyID:strategyId},success:function(e,t){"success"===t&&e.isSucess}})},clicktofollow:function(){},share:function(){var _this=this;with(window._bd_share_config={common:{bdSnsKey:{},bdText:"",bdUrl:pagerouter.share+"?type=2&NewsID="+_this.curPageOpts.NewsID+"&ColumnID="+confColumnID+"&StrategyID="+_this.curPageOpts.StrategyID+"&currpage="+_this.curPageOpts.currpage+"&pageSize="+_this.curPageOpts.pageSize,bdMini:"2",bdMiniList:!1,bdPic:"",bdStyle:"0",bdSize:"16"},share:{}},document)(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion="+~(-new Date/36e5)},share1:function(){var _this=this;function SetConf(e,t){return window.shareId&&(t.bdUrl=window.url,t.bdText=window.title),t}with(window.shareId="",window.strategyId="",window.title="",window.url="",$(function(){$(".bdsharebuttonbox a").off().mouseover(function(){window.shareId=$(this).attr("data-id"),window.strategyId=$(this).attr("data-strategyid"),window.title=$(this).attr("data-title"),window.url=pagerouter.share+"?type=2&NewsID="+window.shareId+"&ColumnID="+confColumnID+"&StrategyID="+window.strategyId+"&currpage=1&pageSize="+_this.curPageOpts.pageSize})}),window._bd_share_config={common:{onBeforeClick:SetConf},share:[{bdSize:12}]},document)(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="http://bdimg.share.baidu.com/static/api/js/share.js?cdnversion="+~(-new Date/36e5)}};page.init(),$.emoneyAanalytics().Init(tjAppid.expert,"celue_article","")});